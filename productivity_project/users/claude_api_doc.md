# Claude AI Integration for Productivity Habits App

## Overview

This document outlines how to integrate Claude AI with the Django application to provide actionable insights, recommendations, and analysis based on user productivity data.

## Integration Points

### 1. Claude API Integration

The first step is to set up API connectivity with Claude:

```python
# productivity_project/claude_api.py
import os
import anthropic
from django.conf import settings

class ClaudeAIClient:
    """Client for interacting with Claude AI API."""
    
    def __init__(self):
        self.client = anthropic.Anthropic(
            api_key=settings.CLAUDE_API_KEY,
        )
        self.model = settings.CLAUDE_MODEL
        self.max_tokens = settings.CLAUDE_MAX_TOKENS
    
    def generate_response(self, prompt, system_prompt=None):
        """Generate a response from Claude based on the given prompt."""
        try:
            message = self.client.messages.create(
                model=self.model,
                max_tokens=self.max_tokens,
                system=system_prompt,
                messages=[
                    {"role": "user", "content": prompt}
                ]
            )
            return message.content[0].text
        except Exception as e:
            # Log error but don't expose API issues to users
            print(f"Claude API error: {e}")
            return "I'm unable to provide insights at the moment. Please try again later."
```

### 2. Settings Configuration

Add the following to your Django settings:

```python
# productivity_project/settings.py
# Claude API Settings
CLAUDE_API_KEY = config('CLAUDE_API_KEY', default='')
CLAUDE_MODEL = config('CLAUDE_MODEL', default='claude-3-haiku-20240307')
CLAUDE_MAX_TOKENS = config('CLAUDE_MAX_TOKENS', default=1000, cast=int)

# Enable/disable Claude integration (useful for testing)
CLAUDE_ENABLED = config('CLAUDE_ENABLED', default=True, cast=bool)
```

### 3. Productivity Insights App

Create a new Django app for Claude-powered insights:

```bash
python manage.py startapp productivity_insights
```

Add to INSTALLED_APPS in settings.py:

```python
INSTALLED_APPS = [
    # ...
    'productivity_insights.apps.ProductivityInsightsConfig',
]
```

### 4. Insights Models

Create models to store Claude's insights and user interactions:

```python
# productivity_insights/models.py
from django.db import models
from django.conf import settings
from django.utils.translation import gettext_lazy as _

class ClaudeInsight(models.Model):
    """Model to store insights generated by Claude."""
    
    INSIGHT_TYPES = [
        ('quarterly', _('Quarterly Analysis')),
        ('weekly', _('Weekly Analysis')),
        ('daily', _('Daily Analysis')),
        ('focus', _('Focus Patterns')),
        ('quest_recommendation', _('Quest Recommendations')),
        ('social', _('Social Events Analysis')),
        ('general', _('General Productivity')),
    ]
    
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name='claude_insights')
    insight_type = models.CharField(_("Insight Type"), max_length=20, choices=INSIGHT_TYPES)
    prompt = models.TextField(_("User Prompt"))
    response = models.TextField(_("Claude Response"))
    created_at = models.DateTimeField(auto_now_add=True)
    is_helpful = models.BooleanField(_("Marked as Helpful"), null=True, blank=True)
    user_feedback = models.TextField(_("User Feedback"), blank=True)
    
    class Meta:
        ordering = ['-created_at']
```

### 5. Data Collection and Prompt Generation

Create utility functions to collect user data and generate prompts for Claude:

```python
# productivity_insights/utils.py
from django.utils import timezone
from datetime import timedelta
import json

from productivity_habits.models import (
    QuarterlyQuest,
    WeeklyReset,
    MorningManifesto,
    FocusSession,
    SocialEvent,
    VoiceNote
)

def collect_quarterly_data(user):
    """Collect data about quarterly quests for analysis."""
    active_quests = QuarterlyQuest.objects.filter(
        user=user,
        status='active'
    ).order_by('end_date')
    
    completed_quests = QuarterlyQuest.objects.filter(
        user=user,
        status='completed'
    ).order_by('-end_date')[:5]
    
    # Get focus time for each quest
    quest_data = []
    for quest in active_quests:
        focus_time = FocusSession.objects.filter(
            user=user,
            project=quest,
            is_completed=True
        ).aggregate(models.Sum('duration_minutes'))['duration_minutes__sum'] or 0
        
        quest_data.append({
            'title': quest.title,
            'category': quest.get_category_display(),
            'days_remaining': quest.days_remaining(),
            'progress': quest.progress,
            'focus_time_minutes': focus_time
        })
    
    return {
        'active_quests': quest_data,
        'completed_quests': [
            {
                'title': quest.title,
                'category': quest.get_category_display()
            } for quest in completed_quests
        ]
    }

def collect_weekly_data(user):
    """Collect data about weekly resets and focus patterns."""
    today = timezone.now().date()
    current_week_start = today - timedelta(days=today.weekday())
    last_week_start = current_week_start - timedelta(days=7)
    
    # Get weekly resets
    current_weekly_reset = WeeklyReset.objects.filter(
        user=user,
        date__gte=current_week_start,
        date__lte=today
    ).first()
    
    last_weekly_reset = WeeklyReset.objects.filter(
        user=user,
        date__gte=last_week_start,
        date__lt=current_week_start
    ).first()
    
    # Get focus data
    focus_sessions = FocusSession.objects.filter(
        user=user,
        is_completed=True,
        date__gte=last_week_start
    ).order_by('date')
    
    # Group focus data by day
    daily_focus = {}
    for session in focus_sessions:
        day_key = session.date.strftime('%Y-%m-%d')
        if day_key not in daily_focus:
            daily_focus[day_key] = 0
        daily_focus[day_key] += session.duration_minutes
    
    return {
        'current_week': {
            'priorities': {
                'priority_1': current_weekly_reset.priority_1 if current_weekly_reset else None,
                'priority_2': current_weekly_reset.priority_2 if current_weekly_reset else None,
                'priority_3': current_weekly_reset.priority_3 if current_weekly_reset else None,
            } if current_weekly_reset else None,
            'quest_notes': current_weekly_reset.quest_notes if current_weekly_reset else None,
        },
        'last_week': {
            'priorities': {
                'priority_1': last_weekly_reset.priority_1 if last_weekly_reset else None,
                'priority_2': last_weekly_reset.priority_2 if last_weekly_reset else None,
                'priority_3': last_weekly_reset.priority_3 if last_weekly_reset else None,
            } if last_weekly_reset else None,
            'wins': last_weekly_reset.wins if last_weekly_reset else None,
        },
        'focus_patterns': daily_focus
    }

def collect_daily_data(user):
    """Collect data about daily manifestos and focus sessions."""
    today = timezone.now().date()
    yesterday = today - timedelta(days=1)
    
    todays_manifesto = MorningManifesto.objects.filter(
        user=user,
        date=today
    ).first()
    
    yesterdays_manifesto = MorningManifesto.objects.filter(
        user=user,
        date=yesterday
    ).first()
    
    focus_sessions_today = FocusSession.objects.filter(
        user=user,
        date=today,
        is_completed=True
    ).order_by('start_time')
    
    total_focus_today = sum(session.duration_minutes for session in focus_sessions_today)
    
    return {
        'today': {
            'adventure': todays_manifesto.todays_adventure if todays_manifesto else None,
            'notes': todays_manifesto.notes if todays_manifesto else None,
            'focus_sessions': [
                {
                    'duration': session.duration_minutes,
                    'description': session.description,
                    'project': session.project.title if session.project else None
                } for session in focus_sessions_today
            ],
            'total_focus_time': total_focus_today
        },
        'yesterday': {
            'adventure': yesterdays_manifesto.todays_adventure if yesterdays_manifesto else None,
            'completed': total_focus_today > 0  # simple heuristic
        }
    }

def generate_quarterly_insight_prompt(user):
    """Generate a prompt for quarterly insights."""
    data = collect_quarterly_data(user)
    
    prompt = f"""
    You are an AI productivity coach analyzing a user's quarterly goals and progress.
    
    Here is the user's current data about their quarterly quests (90-day goals):
    
    Active Quests:
    {json.dumps(data['active_quests'], indent=2)}
    
    Recently Completed Quests:
    {json.dumps(data['completed_quests'], indent=2)}
    
    Based on this data, please provide:
    1. An analysis of their current progress and time management
    2. Suggestions for improving their progress on lagging quests
    3. Recommendations for potential future quests based on their patterns
    4. Any insights about their work-life balance based on the categories
    
    Keep your response conversational, encouraging, and actionable. Limit to 3-4 paragraphs.
    """
    
    return prompt

def generate_weekly_insight_prompt(user):
    """Generate a prompt for weekly insights."""
    data = collect_weekly_data(user)
    
    prompt = f"""
    You are an AI productivity coach analyzing a user's weekly productivity data.
    
    Current Week Priorities:
    {json.dumps(data['current_week'], indent=2)}
    
    Last Week Data:
    {json.dumps(data['last_week'], indent=2)}
    
    Focus Patterns (minutes per day):
    {json.dumps(data['focus_patterns'], indent=2)}
    
    Based on this data, please provide:
    1. An analysis of how well they're focusing on their stated priorities
    2. Suggestions for better time management in the coming days
    3. Reflections on patterns from their focus sessions
    4. Encouragement based on their wins from last week
    
    Keep your response conversational, encouraging, and actionable. Limit to 3-4 paragraphs.
    """
    
    return prompt

def generate_daily_insight_prompt(user):
    """Generate a prompt for daily insights."""
    data = collect_daily_data(user)
    
    prompt = f"""
    You are an AI productivity coach analyzing a user's daily productivity data.
    
    Today's Data:
    {json.dumps(data['today'], indent=2)}
    
    Yesterday's Data:
    {json.dumps(data['yesterday'], indent=2)}
    
    Based on this data, please provide:
    1. Encouragement for today's main adventure (task)
    2. Suggestions for how to approach their main task
    3. Reflections on their focus patterns
    4. A quick tip for maintaining momentum
    
    Keep your response conversational, encouraging, and actionable. Limit to 2-3 paragraphs.
    """
    
    return prompt
```

### 6. Views and Templates

Create views to request and display Claude insights:

```python
# productivity_insights/views.py
from django.shortcuts import render, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.conf import settings

from .models import ClaudeInsight
from .utils import (
    generate_quarterly_insight_prompt,
    generate_weekly_insight_prompt,
    generate_daily_insight_prompt
)
from productivity_project.claude_api import ClaudeAIClient

@login_required
def quarterly_insights(request):
    """View for generating and displaying quarterly insights."""
    user = request.user
    
    # Check if we should generate new insights or use recent ones
    recent_insight = ClaudeInsight.objects.filter(
        user=user,
        insight_type='quarterly'
    ).order_by('-created_at').first()
    
    if request.method == 'POST' or not recent_insight:
        if settings.CLAUDE_ENABLED:
            # Generate insights
            prompt = generate_quarterly_insight_prompt(user)
            
            # Create system prompt
            system_prompt = (
                "You are a helpful, encouraging productivity coach. "
                "Provide insightful analysis based on user productivity data. "
                "Be specific, actionable, and positive. "
                "Keep responses to 3-4 paragraphs maximum."
            )
            
            # Get response from Claude
            claude_client = ClaudeAIClient()
            response = claude_client.generate_response(prompt, system_prompt)
            
            # Save the insight
            insight = ClaudeInsight.objects.create(
                user=user,
                insight_type='quarterly',
                prompt=prompt,
                response=response
            )
        else:
            # Claude integration disabled
            messages.warning(request, "AI insights are currently disabled.")
            return redirect('dashboard')
    else:
        insight = recent_insight
    
    context = {
        'insight': insight
    }
    
    return render(request, 'productivity_insights/quarterly_insights.html', context)

@login_required
def weekly_insights(request):
    """View for generating and displaying weekly insights."""
    user = request.user
    
    # Check if we should generate new insights or use recent ones
    recent_insight = ClaudeInsight.objects.filter(
        user=user,
        insight_type='weekly'
    ).order_by('-created_at').first()
    
    if request.method == 'POST' or not recent_insight:
        if settings.CLAUDE_ENABLED:
            # Generate insights
            prompt = generate_weekly_insight_prompt(user)
            
            # Create system prompt
            system_prompt = (
                "You are a helpful, encouraging productivity coach. "
                "Provide insightful analysis based on user productivity data. "
                "Be specific, actionable, and positive. "
                "Keep responses to 3-4 paragraphs maximum."
            )
            
            # Get response from Claude
            claude_client = ClaudeAIClient()
            response = claude_client.generate_response(prompt, system_prompt)
            
            # Save the insight
            insight = ClaudeInsight.objects.create(
                user=user,
                insight_type='weekly',
                prompt=prompt,
                response=response
            )
        else:
            # Claude integration disabled
            messages.warning(request, "AI insights are currently disabled.")
            return redirect('dashboard')
    else:
        insight = recent_insight
    
    context = {
        'insight': insight
    }
    
    return render(request, 'productivity_insights/weekly_insights.html', context)

@login_required
def daily_insights(request):
    """View for generating and displaying daily insights."""
    user = request.user
    
    # For daily insights, we generally want to generate new ones each time
    if settings.CLAUDE_ENABLED:
        # Generate insights
        prompt = generate_daily_insight_prompt(user)
        
        # Create system prompt
        system_prompt = (
            "You are a helpful, encouraging productivity coach. "
            "Provide insightful analysis based on user productivity data. "
            "Be specific, actionable, and positive. "
            "Keep responses to 2-3 paragraphs maximum."
        )
        
        # Get response from Claude
        claude_client = ClaudeAIClient()
        response = claude_client.generate_response(prompt, system_prompt)
        
        # Save the insight
        insight = ClaudeInsight.objects.create(
            user=user,
            insight_type='daily',
            prompt=prompt,
            response=response
        )
    else:
        # Claude integration disabled
        messages.warning(request, "AI insights are currently disabled.")
        return redirect('dashboard')
    
    context = {
        'insight': insight
    }
    
    return render(request, 'productivity_insights/daily_insights.html', context)

@login_required
def insight_feedback(request, pk):
    """View for submitting feedback on an insight."""
    insight = get_object_or_404(ClaudeInsight, pk=pk, user=request.user)
    
    if request.method == 'POST':
        is_helpful = request.POST.get('is_helpful') == 'true'
        feedback = request.POST.get('feedback', '')
        
        insight.is_helpful = is_helpful
        insight.user_feedback = feedback
        insight.save()
        
        messages.success(request, "Thank you for your feedback!")
        
        # Determine redirect based on insight type
        if insight.insight_type == 'quarterly':
            return redirect('quarterly_insights')
        elif insight.insight_type == 'weekly':
            return redirect('weekly_insights')
        else:
            return redirect('daily_insights')
    
    # GET requests not supported for this view
    return redirect('dashboard')
```

### 7. URL Configuration

Add URLs for the insights app:

```python
# productivity_insights/urls.py
from django.urls import path
from . import views

urlpatterns = [
    path('insights/quarterly/', views.quarterly_insights, name='quarterly_insights'),
    path('insights/weekly/', views.weekly_insights, name='weekly_insights'),
    path('insights/daily/', views.daily_insights, name='daily_insights'),
    path('insights/feedback/<int:pk>/', views.insight_feedback, name='insight_feedback'),
]

# productivity_project/urls.py
# Add this to the main urls.py
path('', include('productivity_insights.urls')),
```

### 8. Templates

Create a base insights template:

```html
<!-- productivity_insights/templates/productivity_insights/base_insight.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">{{ title }}</h4>
            <form method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-light btn-sm">
                    <i class="fas fa-sync-alt me-1"></i> Refresh Insights
                </button>
            </form>
        </div>
        <div class="card-body">
            <div class="mb-4">
                {{ insight.response|linebreaksbr }}
            </div>
            
            <!-- Feedback section -->
            <div class="mt-4 pt-3 border-top">
                <h5>Was this insight helpful?</h5>
                <form method="post" action="{% url 'insight_feedback' pk=insight.pk %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <div class="btn-group" role="group">
                            <button type="submit" name="is_helpful" value="true" class="btn btn-outline-success">
                                <i class="fas fa-thumbs-up me-1"></i> Yes
                            </button>
                            <button type="submit" name="is_helpful" value="false" class="btn btn-outline-danger">
                                <i class="fas fa-thumbs-down me-1"></i> No
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="feedback" class="form-label">Additional feedback (optional)</label>
                        <textarea class="form-control" id="feedback" name="feedback" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        Submit Feedback
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
```

Create specific templates for each insight type:

```html
<!-- productivity_insights/templates/productivity_insights/quarterly_insights.html -->
{% extends 'productivity_insights/base_insight.html' %}

{% block title %}Quarterly Insights | Productivity Habits{% endblock %}

{% block content %}
    {% with title="Quarterly Insights & Recommendations" %}
        {{ block.super }}
    {% endwith %}
{% endblock %}

<!-- productivity_insights/templates/productivity_insights/weekly_insights.html -->
{% extends 'productivity_insights/base_insight.html' %}

{% block title %}Weekly Insights | Productivity Habits{% endblock %}

{% block content %}
    {% with title="Weekly Insights & Recommendations" %}
        {{ block.super }}
    {% endwith %}
{% endblock %}

<!-- productivity_insights/templates/productivity_insights/daily_insights.html -->
{% extends 'productivity_insights/base_insight.html' %}

{% block title %}Daily Insights | Productivity Habits{% endblock %}

{% block content %}
    {% with title="Today's Insights & Recommendations" %}
        {{ block.super }}
    {% endwith %}
{% endblock %}
```

### 9. Dashboard Integration

Update the dashboard to show the insights options:

```html
<!-- Add this to the dashboard template -->
<div class="col-12 mb-4">
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">AI Productivity Insights</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                            <h5>Quarterly Insights</h5>
                            <p class="text-muted">Get AI analysis of your quarterly quests and progress.</p>
                            <a href="{% url 'quarterly_insights' %}" class="btn btn-primary">View Insights</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-calendar-week fa-3x text-primary mb-3"></i>
                            <h5>Weekly Insights</h5>
                            <p class="text-muted">Get AI analysis of your weekly productivity patterns.</p>
                            <a href="{% url 'weekly_insights' %}" class="btn btn-primary">View Insights</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-sun fa-3x text-primary mb-3"></i>
                            <h5>Daily Insights</h5>
                            <p class="text-muted">Get AI recommendations for your day.</p>
                            <a href="{% url 'daily_insights' %}" class="btn btn-primary">View Insights</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

## Security Considerations

1. **API Key Protection**: 
   - Store Claude API keys in environment variables, never in code or version control
   - Use Django's settings and python-decouple to manage sensitive credentials

2. **User Data Protection**:
   - Ensure all user data is properly secured and not shared between different users
   - Implement proper authentication checks on all views
   - Use HTTPS for all API communications

3. **Rate Limiting**:
   - Implement rate limiting for insight generation to prevent API abuse
   - Consider implementing a cooldown period between insight generations

4. **Error Handling**:
   - Gracefully handle API errors without exposing sensitive information
   - Provide fallback functionality when the API is unavailable

## Deployment and Testing

1. **Testing**:
   - Create mock responses for testing without calling the actual API
   - Test edge cases like empty datasets or new users

2. **Monitoring**:
   - Implement logging for API calls and response times
   - Track insight helpfulness ratings to evaluate quality

3. **Gradual Rollout**:
   - Consider an opt-in beta program for the AI features
   - Gather feedback before full deployment

## Future Enhancements

1. **Personalized System Prompts**: Customize system prompts based on user preferences and past feedback
2. **Conversation History**: Allow follow-up questions based on previous insights
3. **Notification Integration**: Send periodic insights via email or push notifications
4. **Specialized Insights**: Add more specific insight types (focus patterns, quest recommendations, etc.)
5. **Voice Note Analysis**: Use Claude to analyze and extract action items from voice notes